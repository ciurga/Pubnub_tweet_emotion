<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8 />
        <title>EON Maps</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            #map {
                position:absolute;
                top:0;
                bottom:0;
                width:100%;
            }
        </style>
        <!--
                <link href="/lib/mapbox.css" rel="stylesheet" />
                <script src="/lib/mapbox.js"></script>
        
                <script src="../bower_components/pubnub/web/pubnub.min.js"></script>
                <script src="../bower_components/subsub/subsub.js"></script>
                <script src="../pubnub-mapbox.js"></script>
        -->
        <script src="//twemoji.maxcdn.com/twemoji.min.js"></script>
        <script type="text/javascript" src="http://pubnub.github.io/eon/v/eon/0.0.9/eon.js"></script>
        <link type="text/css" rel="stylesheet" href="http://pubnub.github.io/eon/v/eon/0.0.9/eon.css" />

        <!--<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>-->
    </head>
    <body>
        <div id='map'></div>
        <script>
            function getNonZeroRandomNumber() {
                var random = Math.floor(Math.random() * 199) - 99;
                if (random == 0)
                    return getNonZeroRandomNumber();
                return random;
            }
        </script>
        <script>
            var channel = 'pubnub-mapbox' + getNonZeroRandomNumber();
            var new_point = [];
            var le;
            var re = /(:\)|:\(|:'\))/;
            //var re = /(:\)|:'\))/;
            
            eon.map({
                id: 'map',
                mb_token: 'pk.eyJ1IjoiaWFuamVubmluZ3MiLCJhIjoiZExwb0p5WSJ9.XLi48h-NOyJOCJuu1-h-Jg',
                mb_id: 'ianjennings.l896mh2e',
                channel: channel,
                marker: function (latlng,data){
                    var marker = new L.Marker(latlng,{
                        icon: L.icon({
                            iconUrl: 'images/grinning-face.png',
                            iconSize: [34,34]
                        })
                    });
                    var popup = data;
                    marker.bindPopup(popup);
                    return marker;
                },
                connect: connect,
                options: {
                    zoomAnimation: false,
                },
            });

            function connect() {

                var me = {
                    icon: {
                        'marker-color': '#ce1126'
                    }
                };
                var them = {
                    icon: {
                        'marker-color': '#29abe2'
                    }
                };

                var point = {
                    latlng: [37.370375, -97.756138]
                            //latlng: [, ]
                };

                var pn = PUBNUB.init({
                    publish_key: 'demo'
                });

                var pn_tweet = PUBNUB.init({
                    subscribe_key: 'sub-c-78806dd4-42a6-11e4-aed8-02ee2ddab7fe'
                })

                //var new_point = JSON.parse(JSON.stringify(point));


                //               setInterval(function () {


                var new_point2 = JSON.parse(JSON.stringify(point));
                var new_point3 = JSON.parse(JSON.stringify(point));
                var new_p;
                /*
                 new_point.latlng = [
                 new_point.latlng[0] + (getNonZeroRandomNumber() * 0.1),
                 new_point.latlng[1] + (getNonZeroRandomNumber() * 0.2)
                 ];
                 */
                pn_tweet.subscribe({
                    channel: 'pubnub-twitter',
                    message: function (msg) {
                        console.log(msg);
                        new_p = msg.place.bounding_box.coordinates[0][0];
                        console.log("point " + msg.place.bounding_box.coordinates[0][0]);
                        console.log("country " + msg.place.country);
                        console.log("message " + msg.text);

                        le = new_point.length;
                        //if (msg.text.includes(":)") || msg.text.includes(":(") || msg.text.includes(":'(")){
                        
                        if (Boolean(msg.text.match(re))){
                        //if (msg.text.includes(":)")){
                            new_point = JSON.parse(JSON.stringify(new_point));
                            new_point[le] = {
                                //marker: new_point[le].marker,
                                // 
                                data: msg.text,
                                latlng: [
                                    new_p[1],
                                    new_p[0]
                                ]
                            };
                            new_point3 = JSON.parse(JSON.stringify(new_point));

                            publish(new_point3);
                        }
                    //}
                    } 
                });

                function publish(nn) {
                    pn.publish({
                        channel: channel,
                        message: nn
                    });
                }


                //              }, 1000);

            }
            ;

        </script>
    </body>
</html>
