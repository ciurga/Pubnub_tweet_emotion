<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8 />
        <title>EON Maps</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <!--<style>
            body {
                margin: 0;
                /*padding: 0px 100px;*/
            }
            .map {
                width: 100%;
                height: 500px;
            }
            .map, #chart {
                margin-top: 60px;
                margin-bottom: 40px;
            }
            p, iframe, h1,h2,h3,h4,h5,h6,p,.map {
                margin: 20px 0px;
            }
            h1 {
                margin-top: 0px;
            }
            .about p {
                opacity: .7;
            }
            .about {
                border-bottom: 1px solid #efefef;
            }
        </style>-->
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            #map {
                position:absolute;
                top:0;
                bottom:0;
                width:100%;
            }
        </style>

        <script src="//twemoji.maxcdn.com/twemoji.min.js"></script>
        <script type="text/javascript" src="http://pubnub.github.io/eon/v/eon/0.0.9/eon.js"></script>
        <link type="text/css" rel="stylesheet" href="http://pubnub.github.io/eon/v/eon/0.0.9/eon.css" />

        <!--<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>-->
    </head>
    <body>
        <header>
            <h1><i class="fa fa-twitter"></i> How is America feeling right now?</h1>
            <p>This map shows the emotional "state" of each state at any given moment. Positive or negative sentiments are loosely determined based on an analysis of key words used in tweets. The realtime data comes from the <a href="https://twitter.com/pubnub" target="_blank">@PubNub</a> Data Stream Network and PubNub's out-of-the-box access to the live Twitter stream.
            </p>
        </header>
        <section id="main">
            <section id="map" class="map"></section>
            <!-- <section class="tweet">
                 <blockquote class="h-entry">
                     <a class="button" role="button" title="Follow on Twitter" href="" target="_blank"><img src="images/twitter-button.png"></a>
                     <div class="header">
                         <div class="name"></div>
                         <div class="screenname"></div>
                     </div>
 
                     <div class="text"></div>
                     <div class="timestamp"></div>
 
                     <div class="actions">
                         <a class="reply" href="" target="_blank"><i class="fa fa-reply"></i></a>
                         <a class="retweet" href="" target="_blank"><i class="fa fa-retweet"></i></a>
                         <a class="favorite" href="" target="_blank"><i class="fa fa-star"></i></a>
                     </div>
                 </blockquote>
                 <div class="emotion"></div>
             </section>-->
        </section>

        <script>
            function getNonZeroRandomNumber() {
                var random = Math.floor(Math.random() * 199) - 99;
                if (random === 0)
                    return getNonZeroRandomNumber();
                return random;
            }

            function d(a) {
                return a.replace(/((https?|s?ftp|ssh)\:\/\/[^"\s\<\>]*[^.,;'">\:\s\<\>\)\]\!])/g, function (a) {
                    return'<a href="' + a + '" >' + a + "</a>"
                })
            }
        </script>
        <script>
            var channel = 'pubnub-mapbox' + getNonZeroRandomNumber();
            var new_point = [];
            var le;
            var re_pos = /(:\)|:\)\)|:'\)|❤)/;
            var re_neg = /(:\(|:\(|:'\( )/;
            var re_love = /❤|\\ud83d\\udc8b /;
            // http://apps.timwhitlock.info/emoji/tables/unicode
            var degree = 0;
            //var re = /(:\)|:'\))/;

            eon.map({
                id: 'map',
                mb_token: 'pk.eyJ1IjoiaWFuamVubmluZ3MiLCJhIjoiZExwb0p5WSJ9.XLi48h-NOyJOCJuu1-h-Jg',
                mb_id: 'ianjennings.l896mh2e',
                channel: channel,
                marker: function (latlng, data, degree) {
                    var marker = new L.Marker(latlng, {
                        icon: L.icon({
                            iconUrl: data[1] > 0 ? 'images/grinning-face.png' : 'images/angry-face.png',
                            iconSize: [34, 34]
                        })
                    });
                    var popup = '<font face="Arial" size="5">' + twemoji.parse(d(data[0])) + "</font>";
                    marker.bindPopup(popup);
                    return marker;
                },
                connect: connect,
                options: {
                    zoomAnimation: false
                }
            });

            function connect() {
                var point = {
                    latlng: [37.370375, -97.756138]
                };

                var pn = PUBNUB.init({
                    publish_key: 'demo'
                });

                var pn_tweet = PUBNUB.init({
                    subscribe_key: 'sub-c-78806dd4-42a6-11e4-aed8-02ee2ddab7fe'
                });

                var new_point3 = JSON.parse(JSON.stringify(point));
                var new_p;

                pn_tweet.subscribe({
                    channel: 'pubnub-twitter',
                    message: function (msg) {

                        if (msg.place !== null) {
                            new_p = msg.place.bounding_box.coordinates[0][0];
                            //console.log("point " + msg.place.bounding_box.coordinates[0][0]);


                            le = new_point.length;
                            var bp = Boolean(msg.text.match(re_pos));
                            var bn = Boolean(msg.text.match(re_neg));
                            if (bp || bn) {
                                //if (msg.lang === 'it'){
                                console.log("country " + msg.place.country + " message " + msg.text);
                                new_point = JSON.parse(JSON.stringify(new_point));
                                new_point[le] = {
                                    degree: bp ? 1 : -1,
                                    data: [msg.text, bp ? 1 : -1],
                                    latlng: [
                                        new_p[1],
                                        new_p[0]
                                    ]
                                };
                                new_point3 = JSON.parse(JSON.stringify(new_point));

                                publish(new_point3);
                            }
                            //}
                        }
                    }
                });

                function publish(nn) {
                    pn.publish({
                        channel: channel,
                        message: nn
                    });
                }
            }
            ;

        </script>
    </body>
</html>
